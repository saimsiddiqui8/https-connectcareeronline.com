<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Listings</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .job-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px;
        }

        .job-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            width: 300px;
            background-color: #f9f9f9;
        }

        .job-title {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #333;
        }

        .job-description {
            font-size: 1em;
            margin-bottom: 10px;
        }

        .job-location {
            font-size: 0.9em;
            color: #777;
        }

        /* Loader styles */
        .loader {
            display: none;
            margin: 20px auto;
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loader.active {
            display: block;
        }
    </style>
</head>

<body>
    <h1>Job Listings</h1>
    <div class="job-container" id="job-container"></div>

    <!-- Loader Element -->
    <div class="loader" id="loader"></div>

    <script>
        let currentPage = 1; // Start with the first page
        const limit = 15; // Set how many jobs to fetch per request
        let isLoading = false; // To prevent duplicate requests

        // Function to fetch paginated jobs
        async function fetchJobs(page = 1, limit = 15) {
            if (isLoading) return; // Prevent fetching when already in progress
            isLoading = true;
            toggleLoader(true); // Show loader

            try {
                const response = await fetch(`http://localhost:8000/api/v1/job/stepstone?page=${page}&limit=${limit}`);
                if (!response.ok) throw new Error('Failed to fetch jobs');

                const xmlData = await response.text();
                // Parse and render the fetched jobs
                parseAndRenderJobs(xmlData);
            } catch (error) {
                console.error('Error fetching jobs:', error);
            } finally {
                isLoading = false; // Reset the loading state
                toggleLoader(false); // Hide loader
            }
        }

        // Function to parse XML and render jobs
        function parseAndRenderJobs(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, 'application/xml');
            const jobs = xmlDoc.getElementsByTagName('job');
            const jobContainer = document.getElementById('job-container');

            Array.from(jobs).forEach(job => {
                const title = job.getElementsByTagName('title')[0].textContent;
                let description = job.getElementsByTagName('description')[0].textContent;
                const location = job.getElementsByTagName('location')[0].textContent;

                // Trimming the description to 150 characters
                description = decodeHtml(description).slice(0, 150) + '...';

                const jobCard = document.createElement('div');
                jobCard.classList.add('job-card');

                jobCard.innerHTML = `
                    <div class="job-title">${title}</div>
                    <div class="job-description">${description}</div>
                    <div class="job-location">${location}</div>
                `;

                jobContainer.appendChild(jobCard);
            });
        }

        // Helper function to decode HTML entities in the XML data
        function decodeHtml(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }

        // Toggle loader visibility
        function toggleLoader(show) {
            const loader = document.getElementById('loader');
            loader.classList.toggle('active', show);
        }

        // Load more jobs when scrolling near the bottom of the page
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                currentPage++;
                fetchJobs(currentPage, limit); // Fetch next page of jobs
            }
        });

        // Fetch the first page of jobs on page load
        fetchJobs(currentPage, limit);
    </script>

</body>

</html>
